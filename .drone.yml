kind: pipeline
type: kubernetes
name: build

workspace:
  path: /drone/src

steps:
  - name: "docker build & push"
    image: plugins/kaniko
    settings:
      dockerfile: Dockerfile
      registry: 192.168.31.5:5050
      username: northes
      password: 26123618
      repo: apihut/server
      tags: latest

node_selector:
  "kubernetes.io/hostname": "worker-1"

trigger:
  branch:
    - dev
    - ci

---
kind: pipeline
type: kubernetes
name: build && deploy

steps:
  - name: docker build tag & push
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: northes/apihut-server
      tags: ${DRONE_TAG##v}

  - name: "chart package"
    image: alpine/helm:3.10.1
    environment:
      username:
        from_secret: helm_username
      password:
        from_secret: helm_password
    commands:
      - helm repo add chartmuseum https://charts.northes.co --username=$username --password=$password
      - helm plugin install https://github.com/chartmuseum/helm-push
      - helm cm-push ./deploy/chart chartmuseum --version=${DRONE_TAG##v} --app-version=${DRONE_TAG##v}

trigger:
  event:
    - tag